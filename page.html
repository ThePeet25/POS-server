<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Listing</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .product-item {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
        }

        .product-item h3 {
            margin-top: 0;
        }

        .pagination-controls {
            margin-top: 20px;
            text-align: center;
        }

        .pagination-controls button {
            padding: 8px 15px;
            margin: 0 5px;
            cursor: pointer;
        }

        .pagination-controls span {
            font-weight: bold;
        }

        .filter-controls {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .filter-controls label,
        .filter-controls input,
        .filter-controls select,
        .filter-controls button {
            margin-right: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <h1>Product Catalog</h1>

    <div class="filter-controls">
        <!-- <label for="search-term">Search:</label> -->
        <!-- <input type="text" id="search-term" placeholder="Product name"> -->

        <label for="category-filter">Category:</label>
        <select id="category-filter">
            <option value="">All Categories</option>
        </select>

        <label for="sort-by">Sort By:</label>
        <select id="sort-by">
            <option value="name">Name</option>
            <option value="price">Price</option>
        </select>

        <label for="sort-order">Order:</label>
        <select id="sort-order">
            <option value="asc">Ascending</option>
            <option value="desc">Descending</option>
        </select>

        <label for="items-per-page">Items per page:</label>
        <input type="number" id="items-per-page" value="20" min="1" max="100">

        <button id="apply-filters">Apply Filters</button>
    </div>

    <div class="product-list" id="product-list">
    </div>

    <div class="pagination-controls">
        <button id="prev-page-btn" disabled>Previous</button>
        <span>Page <span id="current-page-display">1</span> of <span id="total-pages-display">1</span></span>
        <button id="next-page-btn">Next</button>
    </div>

    <!-- <script src="script.js"></script>  -->
    <script>
        const baseURL = 'http://localhost:3000'
        const productListDiv = document.getElementById('product-list');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const currentPageDisplay = document.getElementById('current-page-display');
        const totalPagesDisplay = document.getElementById('total-pages-display');

        const searchTermInput = document.getElementById('search-term');
        const categoryFilterSelect = document.getElementById('category-filter');
        const sortBySelect = document.getElementById('sort-by');
        const sortOrderSelect = document.getElementById('sort-order');
        const itemsPerPageInput = document.getElementById('items-per-page');
        const applyFiltersBtn = document.getElementById('apply-filters');

        let currentPage = 1;
        let itemsPerPage = 20;
        let currentCategoryId = '';
        let currentSearchTerm = '';
        let currentSortBy = 'name';
        let currentSortOrder = 'asc';

        // Function to fetch and display categories (optional, but good for filter)
        async function fetchCategories() {
            try {
                const response = await fetch('/api/categories'); // Assuming you have a /api/categories endpoint
                if (!response.ok) throw new Error('Failed to fetch categories');
                const categories = await response.json();

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categoryFilterSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching categories:', error);
            }
        }


        // Function to fetch products from the API
        async function fetchProductsAndRender() {
            const params = new URLSearchParams({
                page: currentPage.toString(),
                limit: itemsPerPage.toString(),
                sort: currentSortBy,
                sortOrder: currentSortOrder
            });

            if (currentCategoryId) params.append('categoryId', currentCategoryId);
            if (currentSearchTerm) params.append('searchTerm', currentSearchTerm);

            try {
                const response = await fetch(`${baseURL}/product/getporducts?${params.toString()}`,{
                    method: 'GET',
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch products');
                }
                const data = await response.json();

                // Render products
                productListDiv.innerHTML = ''; // Clear previous products
                if (data.products && data.products.length > 0) {
                    data.products.forEach(product => {
                        const productItem = document.createElement('div');
                        productItem.className = 'product-item';
                        productItem.innerHTML = `
                    <h3>${product.name}</h3>
                    <p><strong>Author:</strong> ${product.author || 'N/A'}</p>
                    <p><strong>Price:</strong> ${product.price}</p>
                    <p><strong>Barcode:</strong> ${product.barcode || 'N/A'}</p>
                    <p><strong>Stock:</strong> ${product.quantity}</p>
                `;
                        productListDiv.appendChild(productItem);
                    });
                } else {
                    productListDiv.innerHTML = '<p>No products found.</p>';
                }


                // Update pagination controls
                currentPageDisplay.textContent = data.pagination.currentPage;
                totalPagesDisplay.textContent = data.pagination.totalPages;

                prevPageBtn.disabled = !data.pagination.hasPreviousPage;
                nextPageBtn.disabled = !data.pagination.hasNextPage;

            } catch (error) {
                console.error('Error fetching products:', error);
                productListDiv.innerHTML = '<p>Error loading products.</p>';
                prevPageBtn.disabled = true;
                nextPageBtn.disabled = true;
            }
        }

        // Event listeners for pagination buttons
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                fetchProductsAndRender();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            // We get totalPages from the last successful fetch
            const totalPages = Number(totalPagesDisplay.textContent);
            if (currentPage < totalPages) {
                currentPage++;
                fetchProductsAndRender();
            }
        });

        // Event listener for filter button
        applyFiltersBtn.addEventListener('click', () => {
            // currentSearchTerm = searchTermInput.value.trim();
            // currentCategoryId = categoryFilterSelect.value; // Will be '' if "All Categories" is selected
            currentSortBy = sortBySelect.value;
            currentSortOrder = sortOrderSelect.value;
            itemsPerPage = Number(itemsPerPageInput.value);

            currentPage = 1; // Reset to first page when applying new filters
            fetchProductsAndRender();
        });

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            // fetchCategories(); // Fetch categories for the filter dropdown
            fetchProductsAndRender(); // Fetch and render products for the first time
        });

        // Optional: Add event listener for enter key in search term for convenience
        // searchTermInput.addEventListener('keypress', (event) => {
        //     if (event.key === 'Enter') {
        //         applyFiltersBtn.click(); // Simulate button click
        //     }
        // });
    </script>
</body>

</html>